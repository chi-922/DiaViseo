# DiaViseo Backend System - 종합 개발자 문서

**디아비서(DiaViseo) 백엔드 시스템**은 개인 맞춤형 건강 관리 플랫폼을 위한 **마이크로서비스 아키텍처(MSA)** 기반 시스템입니다.

사용자의 체성분, 식단, 운동, 걸음 수 등 종합적인 건강 데이터를 안전하게 관리하고, AI 기반 개인화된 건강 인사이트를 제공합니다.

---

## 📋 시스템 개요

### 핵심 가치 제안
- **통합 건강 관리**: 체성분, 식단, 운동, 걸음 수 등 모든 건강 지표의 중앙집중식 관리
- **개인화된 분석**: 사용자별 건강 상태 기반 맞춤형 권장사항 및 알림 제공
- **사용자 친화적 기록**: OCR, 이미지 업로드, 자동 계산 등 편리한 데이터 입력 방식
- **안전한 데이터 보호**: 민감한 건강 정보의 암호화 저장 및 엄격한 권한 관리

### 비즈니스 도메인
```
개인 건강 관리 생태계
├── 사용자 관리 (인증, 프로필, SMS 인증)
├── 건강 데이터 (체성분, 식단, 운동, 걸음 수)
├── 개인화 서비스 (알레르기/질환 기반 맞춤 정보)
├── 스마트 알림 (사용자 패턴 기반 동기부여)
└── 데이터 분석 (건강 트렌드, 목표 달성률)
```

---

## 🏗️ MSA 아키텍처 설계

### 전체 시스템 구조
```
┌─────────────────────────────────────────────────────────────────┐
│                    DiaViseo Backend Ecosystem                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Android Client ──────────► Gateway Service (8080)             │
│                                    │                           │
│  ┌─────────────────────────────────┼─────────────────────────┐  │
│  │           Infrastructure Services           │  Business  │  │
│  │                                             │  Services  │  │
│  │  ┌─── Config Service (8888)                │            │  │
│  │  │    └── 중앙 설정 관리                    │  ┌─────────┤  │
│  │  │                                         │  │ Auth    │  │
│  │  ├─── Eureka Service (8761)               │  │ Service │  │
│  │  │    └── 서비스 디스커버리                │  └─────────┤  │
│  │  │                                         │            │  │
│  │  └─── Gateway Service (8080)              │  ┌─────────┤  │
│  │       └── 라우팅, 인증, 로깅                │  │ User    │  │
│  │                                             │  │ Service │  │
│  └─────────────────────────────────────────────┤  └─────────┤  │
│                                                 │            │  │
│                                                 │  ┌─────────┤  │
│                                                 │  │ Health  │  │
│                                                 │  │ Service │  │
│                                                 │  └─────────┤  │
│                                                 │            │  │
│                                                 │  ┌─────────┤  │
│                                                 │  │ Alert   │  │
│                                                 │  │ Service │  │
│                                                 │  └─────────┤  │
│                                                 └────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 서비스 분류 및 역할

#### 🔧 Infrastructure Services (인프라 서비스)
| 서비스 | 포트 | 핵심 역할 | 기술 스택 |
|-------|------|-----------|----------|
| **Config Service** | 8888 | 중앙 설정 관리, 환경별 설정 분리 | Spring Cloud Config |
| **Eureka Service** | 8761 | 서비스 디스커버리, Health Check | Netflix Eureka |
| **Gateway Service** | 8080 | API 라우팅, JWT 인증, 로깅 | Spring Cloud Gateway |

#### 💼 Business Services (비즈니스 서비스)
| 서비스 | 포트 | 핵심 역할 | 데이터 저장소 |
|-------|------|-----------|-------------|
| **Auth Service** | 동적 | OAuth 로그인, JWT 토큰 관리 | Redis |
| **User Service** | 동적 | 회원 관리, SMS 인증, 신체정보 | MySQL, Redis |
| **Health Service** | 동적 | 건강 데이터 통합 관리, 분석 | MySQL, Elasticsearch, MinIO |
| **Alert Service** | 동적 | 개인화 알림, FCM 푸시 발송 | MySQL, RabbitMQ |

#### 📚 Shared Components (공통 모듈)
| 모듈 | 역할 | 제공 기능 |
|------|------|----------|
| **Common Module** | 공통 기능 라이브러리 | ResponseDto, 예외처리, 암호화, WebClient 설정 |

---

## 🔄 서비스 간 통신 및 데이터 흐름

### 동기 통신 (OpenFeign + LoadBalancer)
```
┌─────────────────────────────────────────────────────────────┐
│                    Synchronous Communication                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Auth Service ◄──────► User Service                        │
│  (사용자 존재 확인)       (회원 정보 제공)                    │
│                                                             │
│  Health Service ◄─────► User Service                       │
│  (BMI/BMR 계산)          (신체정보 제공)                      │
│                                                             │
│  Health Service ◄─────► User Service                       │
│  (체성분 동기화)         (사용자 정보 업데이트)                 │
│                                                             │
│  Alert Service ◄──────► User Service                       │
│  (FCM 토큰 조회)         (알림 허용 사용자 목록)               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 비동기 통신 (RabbitMQ Message Queue)
```
┌─────────────────────────────────────────────────────────────┐
│                   Asynchronous Communication                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Health Service ──► RabbitMQ ──► Alert Service             │
│  (알림 요청 발행)      (메시지 큐)   (FCM 푸시 발송)           │
│                                                             │
│  알림 유형:                                                  │
│  ├── 식단 기록 리마인더                                       │
│  ├── 운동 기록 리마인더                                       │
│  ├── 체중 업데이트 알림                                       │
│  └── 비활성 사용자 복귀 유도                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 사용자 요청 처리 플로우
```
1. Android App → Gateway Service (JWT 토큰 포함)
2. Gateway Service: JWT 검증 + 블랙리스트 확인 (Redis)
3. Gateway Service: 라우팅 + X-USER-ID 헤더 추가
4. Business Service: 비즈니스 로직 처리
5. 필요시 다른 서비스 호출 (OpenFeign)
6. 필요시 비동기 알림 발행 (RabbitMQ)
7. Business Service → Gateway Service: 응답 반환
8. Gateway Service → Android App: 표준화된 응답
```

---

## 🗃️ 데이터 저장소 전략

### 서비스별 Database 분리 (Database per Service)
```
┌─────────────────────────────────────────────────────────────┐
│                    Data Storage Architecture                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   MySQL     │  │    Redis    │  │Elasticsearch│         │
│  │             │  │             │  │             │         │
│  │ • user_db   │  │ • 세션관리   │  │ • 음식검색   │         │
│  │ • health_db │  │ • JWT 블랙   │  │ • 한글분석   │         │
│  │ • alert_db  │  │ • SMS 인증   │  │ • 자동완성   │         │
│  │             │  │             │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │   MinIO     │  │  RabbitMQ   │                          │
│  │             │  │             │                          │
│  │ • 식단이미지 │  │ • 알림 큐   │                          │
│  │ • OCR이미지  │  │ • 이벤트    │                          │
│  │ • 썸네일     │  │ • 메시징    │                          │
│  │             │  │             │                          │
│  └─────────────┘  └─────────────┘                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 데이터 일관성 관리
- **Eventual Consistency**: 비동기 메시징으로 최종 일관성 보장
- **Saga Pattern**: 분산 트랜잭션 시 보상 트랜잭션으로 일관성 유지
- **Idempotency**: 중복 처리 방지를 위한 멱등성 보장
- **Soft Delete**: 중요 데이터의 논리적 삭제로 복구 가능성 확보

---

## 🛡️ 보안 및 인증 체계

### JWT 기반 무상태 인증
```
┌─────────────────────────────────────────────────────────────┐
│                    Authentication Flow                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Android App ──► Auth Service: Google OAuth ID Token    │
│                                                             │
│  2. Auth Service ──► Google API: Token 검증               │
│                                                             │
│  3. Auth Service ──► User Service: 회원 존재 확인          │
│                                                             │
│  4. Auth Service: JWT Access Token + Refresh Token 발급     │
│                                                             │
│  5. Android App ──► Gateway: API 호출 (Bearer Token)       │
│                                                             │
│  6. Gateway: JWT 검증 + 블랙리스트 확인 (Redis)             │
│                                                             │
│  7. Gateway ──► Business Service: X-USER-ID 헤더 전달      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 보안 계층별 구현
| 계층 | 보안 구현 | 세부사항 |
|------|-----------|----------|
| **Gateway 계층** | JWT 검증, 블랙리스트 관리 | 모든 외부 요청의 단일 진입점 |
| **Service 계층** | 사용자별 데이터 격리 | X-USER-ID 헤더 기반 소유권 검증 |
| **Data 계층** | 민감정보 암호화 | AES 기반 자동 암호화/복호화 |
| **Network 계층** | HTTPS 통신, 내부 네트워크 | 모든 외부 통신 암호화 |

### 데이터 보호 전략
- **개인정보 암호화**: 체중, 신장 등 민감 정보 AES 암호화 저장
- **토큰 보안**: Access Token 1시간, Refresh Token 100시간 TTL
- **블랙리스트 관리**: 로그아웃된 토큰 실시간 차단
- **입력값 검증**: Spring Validation 기반 모든 입력값 유효성 검사

---

## ⚡ 성능 및 확장성 설계

### 비동기 처리 최적화
```
┌─────────────────────────────────────────────────────────────┐
│                    Performance Optimization                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─── WebFlux (Gateway) ──────────────────────────────────┐ │
│  │ • Non-blocking I/O                                    │ │
│  │ • Reactive Redis 연동                                 │ │
│  │ • 높은 동시성 처리                                     │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─── 비동기 작업 처리 ────────────────────────────────────┐ │
│  │ • OCR 처리: 전용 ThreadPool (30초 타임아웃)           │ │
│  │ • SMS 발송: 비동기 처리로 응답시간 개선               │ │
│  │ • 이미지 업로드: MinIO 병렬 처리                      │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─── 데이터 최적화 ──────────────────────────────────────┐ │
│  │ • MySQL 인덱스: 사용자별, 날짜별 복합 인덱스          │ │
│  │ • Elasticsearch: Nori 분석기 기반 한글 최적화         │ │
│  │ • Redis TTL: 불필요한 데이터 자동 정리                │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 확장성 확보 방안
- **수평 확장**: 모든 서비스가 Stateless로 설계되어 다중 인스턴스 배포 가능
- **Load Balancing**: Eureka 기반 서비스 디스커버리 + 자동 로드밸런싱
- **Cache Layer**: Redis 기반 세션, 블랙리스트, SMS 인증 캐싱
- **Message Queue**: RabbitMQ로 비동기 처리 및 서비스 간 결합도 감소

---

## 🔍 모니터링 및 운영 관리

### 통합 모니터링 시스템
```
┌─────────────────────────────────────────────────────────────┐
│                    Monitoring & Operations                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─── Prometheus Metrics ─────────────────────────────────┐ │
│  │ • 비즈니스 메트릭: 사용자 활성도, 기록 완성률          │ │
│  │ • 시스템 메트릭: API 응답시간, DB 연결 상태           │ │
│  │ • 알림 효과: 발송 건수, 사용자 반응률                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─── Health Check ───────────────────────────────────────┐ │
│  │ • Spring Actuator: /actuator/health                   │ │
│  │ • 외부 의존성: MySQL, Redis, Elasticsearch            │ │
│  │ • 서비스 디스커버리: Eureka Health Check              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─── 구조화된 로깅 ──────────────────────────────────────┐ │
│  │ • 비즈니스 이벤트: 사용자 행동, 데이터 변경           │ │
│  │ • 시스템 이벤트: 서비스 시작/종료, 외부 API 호출      │ │
│  │ • 보안 이벤트: 인증 실패, 비정상 접근                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```


## 🚀 배포 및 운영 가이드

### 서비스 시작 순서
```
1단계: Infrastructure Services
├── Config Service (8888) ──── 중앙 설정 관리
├── Eureka Service (8761) ──── 서비스 디스커버리
└── Gateway Service (8080) ─── API 게이트웨이

2단계: Business Services (순서 무관)
├── Auth Service (동적 포트)
├── User Service (동적 포트)
├── Health Service (동적 포트)
└── Alert Service (동적 포트)

3단계: External Dependencies
├── MySQL (3306)
├── Redis (6379)
├── Elasticsearch (9200)
├── MinIO (9000)
└── RabbitMQ (5672)
```

### 환경별 설정 관리
```yaml
# Config Service에서 중앙 관리
├── application.yml          # 공통 설정
├── application-dev.yml      # 개발 환경
├── application-staging.yml  # 스테이징 환경
└── application-prod.yml     # 운영 환경

# 민감 정보는 환경변수로 관리
- MYSQL_PASSWORD
- REDIS_PASSWORD
- JWT_SECRET_KEY
- ENCRYPTION_PASSWORD
- COOLSMS_API_KEY
```

## 🧪 테스트 전략

### 테스트 계층별 구현
```
┌─────────────────────────────────────────────────────────────┐
│                      Testing Strategy                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─── Unit Tests ────────────────────────────────────────┐  │
│  │ • Service Layer 비즈니스 로직                         │  │
│  │ • Util 클래스 및 Common Module                        │  │
│  │ • 암호화/복호화, JWT 검증 로직                        │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─── Integration Tests ─────────────────────────────────┐  │
│  │ • Controller + Service 통합 테스트                    │  │
│  │ • Database 연동 테스트 (TestContainers)              │  │
│  │ • 외부 API 연동 테스트 (WireMock)                    │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─── E2E Tests ─────────────────────────────────────────┐  │
│  │ • 전체 서비스 통합 시나리오                           │  │
│  │ • 사용자 여정 기반 테스트                             │  │
│  │ • 성능 및 부하 테스트                                 │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 주요 테스트 시나리오
1. **인증 플로우**: OAuth 로그인 → JWT 발급 → API 호출
2. **건강 데이터 기록**: 체성분 → 식단 → 운동 → 통계 조회
3. **알림 시스템**: 데이터 기록 → 알림 발행 → FCM 푸시 발송
4. **장애 복구**: 서비스 다운 → 자동 복구 → 데이터 일관성 확인

---

## 🔧 트러블슈팅 가이드

### 일반적인 문제 및 해결책

#### 🚨 서비스 시작 실패
**증상**: 서비스가 시작되지 않거나 Eureka에 등록되지 않음
```bash
# 1. Config Service 확인
curl http://localhost:8888/actuator/health

# 2. Eureka Service 확인
curl http://localhost:8761/actuator/health

# 3. 서비스별 설정 확인
curl http://localhost:8888/{service-name}/default
```

#### 🚨 JWT 인증 실패
**증상**: 401 Unauthorized 오류 발생
```bash
# 1. 토큰 유효성 확인
# 2. 블랙리스트 상태 확인 (Redis)
# 3. Gateway 로그 확인
# 4. Auth Service 상태 확인
```

#### 🚨 데이터베이스 연결 실패
**증상**: 서비스는 시작되지만 DB 관련 작업 실패
```yaml
# 1. 연결 정보 확인
# 2. 네트워크 연결 상태 점검
# 3. 데이터베이스 서버 상태 확인
# 4. Connection Pool 설정 검토
```

#### 🚨 메시지 큐 처리 지연
**증상**: 알림이 발송되지 않거나 지연됨
```bash
# 1. RabbitMQ 서버 상태 확인
# 2. Queue 적체 상황 확인
# 3. Consumer 서비스 상태 점검
# 4. 메시지 처리 로그 분석
```

---

## 📈 향후 개선 및 확장 계획

### 단기 개선사항 (3개월)
- **성능 최적화**: Redis 캐싱 전략 도입, 데이터베이스 쿼리 최적화
- **보안 강화**: API Rate Limiting, CORS 정책 적용
- **모니터링 고도화**: Grafana 대시보드 구축, 알람 시스템 구축

### 중기 개선사항 (6개월)
- **AI/ML 기능**: 이미지 기반 음식 인식, 개인화 추천 알고리즘
- **확장성 개선**: Kubernetes 기반 컨테이너 오케스트레이션
- **데이터 분석**: 사용자 행동 분석, 건강 인사이트 고도화

### 장기 비전 (1년+)
- **글로벌 확장**: 다국어 지원, 지역별 건강 기준 적용
- **플랫폼 확장**: 웨어러블 기기 연동, 의료진 협업 시스템
- **기술 혁신**: 실시간 스트리밍 분석, GraphQL 도입

---

## 📋 참고 자료

### 시스템 명세서
- **API 문서**: 각 서비스별 상세 API 스펙
- **데이터베이스 스키마**: ERD 및 테이블 설계서
- **인프라 구성도**: 네트워크 토폴로지 및 보안 정책

### 운영 가이드
- **배포 매뉴얼**: 환경별 배포 절차 및 체크리스트
- **모니터링 대시보드**: Prometheus + Grafana 설정 가이드
- **장애 대응 매뉴얼**: 상황별 대응 절차 및 연락처

### 개발 가이드
- **코딩 컨벤션**: Java, Spring Boot 기반 개발 표준
- **Git 워크플로우**: 브랜치 전략 및 코드 리뷰 가이드
- **테스트 가이드**: 단위/통합 테스트 작성 및 실행 방법

---

**이 문서는 DiaViseo 백엔드 시스템의 전체적인 아키텍처와 설계를 다룹니다. 각 서비스의 상세한 구현 내용은 해당 서비스별 개발자 문서를 참조하시기 바랍니다