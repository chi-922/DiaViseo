# Nutrition 모듈 개요

**디아비서(DiaViseo) Health Service 내 Nutrition 모듈은 사용자의 식단 관리, 영양소 분석, 식사 기록을 담당하는 핵심 서비스입니다.**

---

## 📌 모듈 개요

### Nutrition 모듈의 역할
**Nutrition 모듈**은 Health Service의 핵심 구성요소로, 사용자의 건강한 식습관 형성을 지원하는 종합적인 영양 관리 시스템입니다.

- **음식 정보 관리**: 10,000+ 음식 데이터베이스 기반 영양소 정보 제공
- **개인화된 식단 관리**: 사용자별 식사 기록, 즐겨찾기, 맞춤 음식 세트
- **실시간 영양 분석**: 일일/주간/월간 영양소 섭취량 계산 및 분석
- **시각적 식단 기록**: MinIO 기반 식사 이미지 업로드 및 관리
- **데이터 기반 인사이트**: 연령/성별 기준 영양 섭취 비교 분석
- **타 서비스 연동**: User Service 신체정보, Alert Service 알림 시스템

### 핵심 가치 제안
1. **편리한 식단 기록**: 이미지와 함께하는 직관적인 식사 입력
2. **정확한 영양 분석**: 개인 맞춤형 영양소 계산 및 권장량 비교
3. **지속가능한 관리**: 통계 기반 식습관 트렌드 모니터링
4. **개인화 서비스**: 즐겨찾기, 음식 세트 등 사용자 맞춤 기능

---

## 🏗️ 시스템 아키텍처

### 전체 구조
```
┌─────────────────────────────────────────────────────────────┐
│                    Health Service                           │
│  ┌─────────────────────────────────────────────────────────┤
│  │                Nutrition Module                         │
│  ├─────────────────────────────────────────────────────────┤
│  │  Controller Layer                                       │
│  │  ├── FoodController (음식 정보 관리)                    │
│  │  ├── FavoriteController (즐겨찾기 관리)                │
│  │  ├── FoodSetController (음식 세트 관리)                 │
│  │  ├── MealController (식단 기록 관리)                    │
│  │  ├── MealImageController (이미지 관리)                  │
│  │  └── MealStatisticsController (통계 분석)              │
│  ├─────────────────────────────────────────────────────────┤
│  │  Service Layer                                          │
│  │  ├── FoodService (음식 조회 로직)                      │
│  │  ├── FavoriteService (즐겨찾기 로직)                   │
│  │  ├── FoodSetService (음식 세트 로직)                   │
│  │  ├── MealService (식단 기록 로직)                      │
│  │  ├── MealImageService (이미지 처리)                    │
│  │  └── MealStatisticsService (통계 계산)                │
│  ├─────────────────────────────────────────────────────────┤
│  │  Repository Layer                                       │
│  │  ├── FoodRepository (음식 데이터)                      │
│  │  ├── FavoriteFoodRepository (즐겨찾기 데이터)          │
│  │  ├── FoodSetRepository (음식 세트 데이터)              │
│  │  ├── MealRepository (식단 데이터)                      │
│  │  ├── MealTimeRepository (식사 시간 데이터)             │
│  │  └── MealFoodRepository (식단 음식 데이터)             │
│  └─────────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────┘
```

### 외부 시스템 연동
```
                    ┌─────────────────┐
                    │   Android App   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │    Gateway      │
                    └─────────┬───────┘
                              │
        ┌─────────────────────▼─────────────────────┐
        │              Health Service              │
        │         (Nutrition Module)               │
        └─┬─────────────────────────────────────┬─┘
          │                                     │
    ┌─────▼─────┐                         ┌────▼────┐
    │User Service│◄──── 신체정보 연동 ────┤MinIO    │
    │(신체정보)  │                         │(이미지) │
    └───────────┘                         └─────────┘
          │
    ┌─────▼─────┐
    │Alert Svc  │◄──── 식사 알림 연동
    │(RabbitMQ) │
    └───────────┘
```

---

## 🔧 핵심 기능

### 1. 음식 정보 관리
**개요**: 체계적인 음식 데이터베이스 기반 영양 정보 제공

**주요 기능**:
- **음식 검색 및 조회**: 10,000+ 음식 데이터베이스에서 영양소 정보 조회
- **상세 영양소 정보**: 칼로리, 탄수화물, 단백질, 지방, 나트륨 등 10가지 영양소
- **즐겨찾기 시스템**: 자주 먹는 음식 개인화 관리
- **최근 음식 기록**: 사용자 식사 패턴 기반 편의 기능

**기술적 특징**:
- JPA 기반 효율적인 데이터 조회
- 즐겨찾기 배치 쿼리로 성능 최적화
- 사용자별 개인화 데이터 매핑

### 2. 음식 세트 관리
**개요**: 사용자 정의 음식 조합으로 식단 입력 효율성 극대화

**주요 기능**:
- **맞춤 세트 생성**: 자주 먹는 음식 조합을 세트로 저장
- **영양소 자동 계산**: 세트 내 모든 음식의 총 영양소 실시간 계산
- **세트 관리**: 생성, 수정, 삭제, 조회 전체 라이프사이클 지원
- **소유권 보안**: 사용자별 세트 접근 권한 엄격 관리

**기술적 특징**:
- FoodSet ↔ FoodSetFood 매핑 테이블 구조
- 영양소 합계 실시간 계산 로직
- orphanRemoval을 통한 연관 데이터 자동 정리

### 3. 식단 기록 관리
**개요**: 시각적 식사 기록과 정확한 영양소 추적 시스템

**주요 기능**:
- **이미지 기반 식단 기록**: MinIO 연동 고품질 이미지 업로드
- **시간대별 관리**: 아침/점심/저녁/간식 구분 관리
- **실시간 영양 계산**: 음식별 수량 반영한 정확한 영양소 계산
- **유연한 삭제 시스템**: 전체/날짜별/시간대별/개별음식 단위 삭제
- **날짜 기반 조회**: 당일, 특정 날짜, 기간별 식단 조회

**기술적 특징**:
- Meal → MealTime → MealFood 3계층 구조
- MinIO 기반 이미지 스토리지 (UUID 기반 파일명)
- Soft Delete를 통한 데이터 보존
- 복잡한 영양소 집계 쿼리 최적화

### 4. 영양소 분석 시스템
**개요**: 개인 맞춤형 영양 상태 분석 및 권장사항 제공

**주요 기능**:
- **일일 영양 분석**: 실시간 영양소 섭취량 계산
- **주간 트렌드 분석**: 7일간 평균 섭취 패턴 추적
- **기간별 통계**: 일별/주별/월별 영양 섭취 통계
- **기준값 비교**: 연령/성별 기준 권장량 대비 분석

**기술적 특징**:
- 복잡한 MySQL 집계 쿼리 (YEARWEEK, GROUP BY)
- 쿼리 실패 시 애플리케이션 레벨 대체 로직
- 빈 데이터 처리 및 0값 채움 로직

### 5. 이미지 관리 시스템
**개요**: 식단의 시각적 기록을 위한 전문 이미지 처리 서비스

**주요 기능**:
- **다중 형식 지원**: JPG, PNG, GIF, WebP 지원
- **자동 최적화**: MIME 타입 자동 감지 및 설정
- **URL 관리**: 내부/외부 엔드포인트 분리로 유연한 접근 제어
- **수명주기 관리**: 이미지 업로드, 연결, 조회, 삭제 전체 관리

**기술적 특징**:
- MinIO 객체 스토리지 연동
- UUID 기반 중복 없는 파일명 생성
- 외부 엔드포인트 설정으로 CDN 연동 준비

---

## 💾 데이터 모델

### 핵심 엔티티 관계
```
User (외부) ─┬─→ FavoriteFood ──→ Food
             ├─→ FoodSet ──→ FoodSetFood ──→ Food
             └─→ Meal ──→ MealTime ──→ MealFood ──→ Food
                            │
                            └─→ MealType (BREAKFAST/LUNCH/DINNER/SNACK)

영양 기준 데이터:
MaleNutrientStandard ─── AgeGroup (10대~60대, 65세+)
FemaleNutrientStandard ─── AgeGroup
MaleNutrientIntake ─── AgeGroup  
FemaleNutrientIntake ─── AgeGroup
```

### 주요 테이블 구조

**음식 정보 (food_information_tb)**
- 기본 음식 데이터베이스 (10,000+ 건)
- 10가지 영양소 정보 (칼로리, 탄수화물, 단백질, 지방, 당, 나트륨, 포화지방, 트랜스지방, 콜레스테롤)
- Soft Delete 지원

**식단 기록 (meal_tb, meal_time_tb, meal_food_tb)**
- 3계층 정규화 구조로 유연한 식단 관리
- 날짜/시간대/음식 단위별 세밀한 제어
- 이미지 URL 필드로 시각적 기록 지원

**영양 기준 데이터**
- 연령대/성별 구분 영양 권장량 및 평균 섭취량
- 애플리케이션 시작 시 자동 로딩
- 사용자 섭취량과 비교 분석 기준

---

## 🔄 서비스 연동

### User Service 연동
**목적**: 사용자 신체정보 기반 개인화된 영양 권장량 제공

**연동 데이터**:
- 사용자 나이, 성별 → 영양소 기준값 매핑
- BMR/TDEE 정보 → 권장 칼로리 계산
- 사용자 목표 (체중 감량/증량/유지) → 맞춤 권장사항

**연동 방식**: 
- 직접 API 호출 없이 사용자 입력 기반 계산
- 향후 User Service API 연동으로 실시간 권장량 제공 가능

### Alert Service 연동  
**목적**: 식사 시간 알림 및 영양 상태 기반 푸시 발송

**연동 데이터**:
- 사용자 식사 패턴 → 개인화된 식사 알림 시간
- 영양소 부족/과다 → 건강 관리 알림
- 목표 달성 현황 → 동기부여 메시지

**연동 방식**:
- RabbitMQ 기반 비동기 메시지 발송
- Exchange: `alert-exchange`
- Routing Key: `alert.push.meal.requested`

### MinIO 스토리지 연동
**목적**: 식단 이미지의 안정적인 저장 및 관리

**연동 특징**:
- 내부/외부 엔드포인트 분리로 보안성 확보
- UUID 기반 파일명으로 중복 방지
- 다중 이미지 형식 지원
- CDN 연동 준비된 URL 구조

---

## ⚡ 성능 및 확장성

### 성능 최적화 전략

**데이터베이스 최적화**:
- 핵심 쿼리 인덱스 최적화 (user_id, meal_date, food_id 조합)
- 즐겨찾기 배치 쿼리로 N+1 문제 해결
- 복잡한 통계 쿼리 최적화 및 대체 로직 구현

**메모리 효율성**:
- DTO 최적화로 불필요한 데이터 전송 최소화
- JPA 지연 로딩 활용
- 대용량 데이터 처리 시 페이징 적용

**응답 시간 관리**:
- 이미지 업로드: 2-5초 (MinIO 처리 시간)
- 일반 조회: 100-300ms 목표
- 통계 계산: 500-1000ms (복잡한 집계 쿼리)

### 확장 가능성

**데이터 증가 대응**:
- 월별/연도별 파티셔닝 전략 수립
- 3년 이상 데이터 아카이빙 계획
- 인덱스 전략 지속 모니터링

**기능 확장 준비**:
- 음식 데이터베이스 지속 확장 (현재 10,000+ → 50,000+ 목표)
- AI 기반 음식 인식 기능 연동 준비
- 개인화 추천 알고리즘 도입 기반 마련

---

## 🛡️ 보안 및 안정성

### 데이터 보안
- **소유권 검증**: 모든 개인 데이터 접근 시 사용자 권한 엄격 검증
- **Soft Delete**: 중요 데이터 논리적 삭제로 복구 가능성 확보
- **입력값 검증**: 모든 API 입력값 유효성 검사

### 시스템 안정성
- **트랜잭션 관리**: 복잡한 데이터 조작 시 ACID 보장
- **예외 처리**: Common Module 기반 일관된 에러 응답
- **대체 로직**: 복잡한 쿼리 실패 시 애플리케이션 레벨 처리

---